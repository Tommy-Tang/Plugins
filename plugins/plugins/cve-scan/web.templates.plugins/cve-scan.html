{% extends 'layouts/master-page' %}
{% block title %}CVE-Scan{% endblock %}
{% block head %}
  <script>
    $(document).ready(function(){
      $("#GenerateButton").click(function(){
        $("#Output").html('<strong>Processing:</strong><br /><div class="progress"><div class="progress-bar progress-bar-striped active" role="progressbar" style="width: 100%"></div></div>')
        $("#GenerateButton").prop("disable", true);
        $("#OutputSelect").prop("disable", true);
        success=false;
        data = {'scan': $("#ScanInput").val(), 'store': $('#store').prop( "checked" ), 'tags': $('#tags').val(), 'notes': $('#notes').val()}
        url = '/plugin/{{plug_id}}/_cve_action/'
        switch($("#OutputSelect").val()){
          case "json":
            $.getJSON(url+"json",data,function(data){ $("#Output").html("<pre>"+data['data']+"</pre>"); })
            break;
          case "pdf":
            $.getJSON(url+"pdf",data,function(data){ 
              var lnk = document.createElement("a");
              lnk.setAttribute("id", "pdf_report");
              lnk.download = "report.pdf";
              lnk.href = "data:application/pdf;base64,"+data['data'];
              document.body.appendChild(lnk);
              $('#pdf_report')[0].click();
              $('#pdf_report').remove();
              $("#Output").html("<p>PDF Generated</p>");
            });
            break;
          case "webview":
            $.getJSON(url+"webview",data,function(data){ $("#Output").html(data['data']); })
            break;
        }
        $("#GenerateButton").prop("disable", false)
        $("#OutputSelect").prop("disable", false)
      });
    });
  </script>
  <style>
    #bodystrap{
      width: 90%;
      margin: auto;
    }
    .wideText{
      width: 100%;
      height: 200px;
      resize: vertical;
    }
    .listInput{
      width:calc(50% - 25px);
      min-width:200px;
    }
    .listInput textarea, input[type=text]{
      width:100%;
      resize: vertical;
    }
  </style>
{% endblock %}
{% block content %}
  <!-- breadcrumb -->
  <ol class="breadcrumb">
    <li><a href="/">Home</a></li>
    <li class="active">CVE-Scan</li>
  </ol>
  <div class="well" id="bodystrap">
    <ul class="nav nav-tabs">
      <li role="presentation" class="active"><a href="#">CVE-Scan</a></li>
      <li role="presentation"><a href="/plugin/{{plug_id}}/subpage/settings">Settings</a></li>
    </ul>
    <h1>CVE-Scan</h1>
    <p>
      CVE-Scan transforms XML output of NMAP into an overview of vulnerabilities in the scanned system.
      <ol>
        <li>Scan the system(s) with NMAP, using the -A and/or -O flag, and paste the XML output below.</li>
        <li>Select the output method (JSON, PDF or the built-in display viewer)</li>
        <li>Hit the "Analyze and output" button, and wait for the output.</li>
      </ol>
    </p>
    <h2>CVE-Search Plugin</h2>
    <div class="well">
      <p>
        <strong>[1] Input the nmap xml below:</strong> <br />
        <textarea id="ScanInput" class='wideText'></textarea>
      </p>
      <p>
        <strong>[2] Select output method</strong> <br />
        <select id="OutputSelect">
          <option value="json">   JSON   </option>
          <option value="pdf">    PDF    </option>
          <option value="webview">Webview</option>
        </select>
      </p>
      <p>
        <strong>[optional] Add tags and/or notes</strong> <br />
        <table class="table">
          <tr>
            <td class="listInput">Notes: <textarea id="notes" rows="3" placeholder="Notes..."></textarea> </td>
            <td class="listInput">Tags:  <textarea id="tags"  rows="1" placeholder="Tags, separated by ,"></textarea> </td>
          </tr>
        </table>
      </p>
      <p>
        <strong>[3] Go</strong> <br />
        <strong>Store in the database:</strong> <input type="checkbox" id="store"> <br />
        <button id="GenerateButton">Analyze and output</button>
      </p>
      <p>
        <strong>[4] Output:</strong>
        <div id="Output"> <span>No output yet.</span></div>
      </p>
    </div>
  </div>
{% endblock %}
